<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ï–≥–æ—Ä—ã—á ‚Äî –≥–æ–ª–æ—Å–æ–º –∏ –ø–æ-—Ä—É—Å—Å–∫–∏</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 1rem;
      background: #fff;
      color: #000;
    }
    .chat {
      margin-top: 1rem;
    }
    .chat div {
      margin-bottom: 0.75rem;
    }
    .user {
      font-weight: bold;
    }
    .assistant {
      margin-left: 1rem;
    }
    textarea {
      width: 100%;
      height: 60px;
      margin-top: 1rem;
    }
    button {
      margin-top: 0.5rem;
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <h1>üéôÔ∏è –ï–≥–æ—Ä—ã—á ‚Äî –≥–æ–ª–æ—Å–æ–º –∏ –ø–æ-—Ä—É—Å—Å–∫–∏</h1>

  <textarea id="textInput" placeholder="–ù–∞–ø–∏—à–∏ –ï–≥–æ—Ä—ã—á—É..."></textarea>
  <br />
  <button onclick="sendText()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  <button onclick="startRecording()">üî¥ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
  <button onclick="stopRecording()">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

  <div class="chat" id="chat"></div>

  <script>
    const API_BASE = "https://egorych-backend-production.up.railway.app";

    async function sendText() {
      const input = document.getElementById("textInput").value;
      if (!input) return;

      addMessage("user", input);
      const res = await fetch(`${API_BASE}/chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: input })
      });

      const data = await res.json();
      addMessage("assistant", data.reply);

      const speakRes = await fetch(`${API_BASE}/speak`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: data.reply })
      });

      const audioBlob = await speakRes.blob();
      const audioUrl = URL.createObjectURL(audioBlob);
      const audio = new Audio(audioUrl);
      audio.play();
    }

    function addMessage(role, text) {
      const div = document.createElement("div");
      div.className = role;
      div.innerText = `${role === "user" ? "–¢—ã:" : "–ï–≥–æ—Ä—ã—á:"} ${text}`;
      document.getElementById("chat").appendChild(div);
    }

    let mediaRecorder;
    let audioChunks = [];

    function startRecording() {
      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      });
    }

    function stopRecording() {
      if (!mediaRecorder) return;
      mediaRecorder.stop();
      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/mp3" });
        const formData = new FormData();
        formData.append("audio", audioBlob, "voice.mp3");

        const res = await fetch(`${API_BASE}/whisper`, {
          method: "POST",
          body: formData
        });

        const data = await res.json();
        document.getElementById("textInput").value = data.text;
        sendText();
      };
    }
  </script>
</body>
</html>
